# ChromaCloud Fixes - February 16-17, 2026

## Summary
Fixed three issues for macOS compatibility and improved user experience.

## Issue 1: macOS Title Bar Dark Mode Support âœ…

### Problem
- Window title bars on macOS did not follow the Dark Mode setting
- Only Windows 11 title bar API was implemented
- Initial implementation didn't work because NSWindow API needs to be called after window is shown

### Solution (Updated Feb 17, 2026)
- Updated `_update_windows_title_bar()` in both `CC_Main.py` and `CC_StatisticsWindow.py`
- Added macOS-specific title bar appearance control using NSWindow API
- **Key Fix**: Added `showEvent()` handler to update title bar AFTER window is displayed
- Implemented two fallback methods:
  1. **pyobjc bridge** (preferred): Uses PyObjC to call Cocoa NSAppearance API
  2. **ctypes fallback**: Direct Objective-C runtime calls via ctypes if pyobjc not available

### Technical Details
```python
def showEvent(self, event):
    """Handle window show event - update macOS title bar"""
    super().showEvent(event)
    if platform.system() == "Darwin":
        self._update_macos_title_bar()

def _update_macos_title_bar(self):
    # Method 1: PyObjC (if available)
    import objc
    from AppKit import NSAppearance
    
    ns_view = objc.objc_object(c_void_p=int(self.winId()))
    ns_window = ns_view.window()
    appearance = NSAppearance.appearanceNamed_("NSAppearanceNameDarkAqua")
    ns_window.setAppearance_(appearance)
    
    # Method 2: Pure ctypes fallback (no dependencies)
    # Uses Objective-C runtime directly via libobjc.dylib
```

### Files Modified
- `CC_Main.py`: Added macOS title bar support with showEvent
- `CC_StatisticsWindow.py`: Added macOS title bar support with showEvent

### Testing on macOS
1. Run ChromaCloud: `python CC_Main.py`
2. Switch between Light/Dark/System modes in View menu
3. Title bar should change color immediately:
   - **Dark Mode**: Title bar becomes dark gray/black
   - **Light Mode**: Title bar becomes white/light gray
4. Open Statistics window - title bar should match theme

**Note**: PyObjC package improves reliability but is optional and **macOS-only**. 

**On macOS**, install with:
```bash
pip install pyobjc-framework-Cocoa
# Or use the provided requirements file:
pip install -r requirements-macos.txt
```

**On Windows/Linux**: Don't install pyobjc - the code automatically uses platform-specific APIs:
- Windows 11: Uses DWM API for title bar
- Linux: Uses Qt default behavior
- The macOS code is safely skipped on other platforms

---

## Issue 2: Reorder Statistics Tabs & Auto-Show Hue Comparison âœ…

### Problem
- Comparison charts (most frequently used) were buried in later tabs
- Window opened to "Overview" tab by default
- User had to click through to find Hue Comparison

### Solution
- Reordered tabs to prioritize most-used features:
  1. ðŸŒˆ Hue Comparison (NEW: default tab)
  2. ðŸ’§ Saturation Comparison
  3. ðŸ’¡ Lightness Comparison
  4. ðŸ“ˆ Overview
  5. ðŸŽ¨ Hue Distribution
  6. ðŸ“Š HSL Scatter
- Set `tabs.setCurrentIndex(0)` to auto-show Hue Comparison

### User Impact
- Statistics window now opens directly to the most useful chart
- One-click access to all comparison features
- Better workflow efficiency

### Files Modified
- `CC_StatisticsWindow.py`: Reordered tabs and set default

---

## Issue 3: Show Thumbnails from Database When USB Offline âœ…

### Problem
- When external USB drive is disconnected, tooltips in Statistics window couldn't display photos
- Thumbnails were stored in database but not being used as fallback
- Showed only text placeholder instead of cached image

### Solution
- Pass database instance (`db`) to `CC_StatisticsWindow`
- Updated tooltip hover logic to use 3-tier fallback:
  1. **File exists** â†’ Load from disk (fastest, highest quality)
  2. **File offline + DB has thumbnail** â†’ Load from database cache
  3. **No thumbnail** â†’ Show text with "ðŸ“· (offline)" indicator

### Technical Details
```python
# Try loading from database if file doesn't exist
if self.db:
    cached = self.db.get_thumbnail_cache(path)
    if cached and cached.get('thumbnail_data'):
        pixmap = QPixmap()
        pixmap.loadFromData(cached['thumbnail_data'])
```

### User Impact
- Statistics window now fully functional even when USB drive is disconnected
- Seamless offline experience - charts and photo previews still work
- No more missing images in tooltips

### Files Modified
- `CC_Main.py`: Pass `db=self.db` to statistics window
- `CC_StatisticsWindow.py`: 
  - Accept `db` parameter in constructor
  - Update tooltip hover to use database thumbnails as fallback

---

## Testing Notes

### macOS Title Bar
- **macOS only**: Requires `pyobjc-framework-Cocoa` for best experience
- Falls back to ctypes method if pyobjc not available
- Install on macOS: `pip install -r requirements-macos.txt`
- **Windows/Linux**: Skip pyobjc installation - platform-specific code is used automatically

### Database Thumbnails
- Works immediately - no additional packages needed
- Thumbnails are already cached during photo grid display
- Test by:
  1. Open ChromaCloud and view album
  2. Open Statistics â†’ Hover over bars (photos load)
  3. Disconnect USB drive
  4. Hover over bars again â†’ Thumbnails still appear from DB

---

## Compatibility

- **macOS**: Full dark mode title bar support (with pyobjc)
- **Windows 11**: Existing dark mode title bar support maintained
- **Linux**: No title bar API (uses Qt defaults)

---

## Future Enhancements

- Consider caching higher-resolution thumbnails for better Statistics window display
- Add loading indicator while fetching database thumbnails
- Implement thumbnail preloading when Statistics window opens

