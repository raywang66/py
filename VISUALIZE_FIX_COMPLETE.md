# Visualize æŒ‰é’®å®Œå…¨ä¿®å¤ + å»¶è¿ŸåŠ è½½ä¼˜åŒ–
Date: 2026-02-03

## âœ… å®Œæˆçš„ä¿®å¤

### ä¿®å¤ 1: ValueError - numpy æ•°ç»„å¸ƒå°”åˆ¤æ–­é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```python
ValueError: The truth value of an array with more than one element is ambiguous. 
Use a.any() or a.all()
```

**é—®é¢˜åŸå› **:
```python
if not self.current_photo or not self.point_cloud:  # âŒ é”™è¯¯
    # self.point_cloud æ˜¯ numpy æ•°ç»„
    # not self.point_cloud ä¼šå¼•å‘ ValueError
```

**ä¿®å¤æ–¹æ³•**:
```python
if not self.current_photo or self.point_cloud is None:  # âœ… æ­£ç¡®
    # ä½¿ç”¨ 'is None' è€Œä¸æ˜¯ 'not' æ¥æ£€æŸ¥ numpy æ•°ç»„
```

**ä½ç½®**: `CC_Main.py` ç¬¬ 1928 è¡Œ

---

### ä¿®å¤ 2: æ•´åˆ CC_Visualization3DWindow ç±»

**ä» `CC_MainApp_restored.py` æå–å¹¶æ•´åˆåˆ° `CC_Main.py`**

#### æå–çš„ç±»
- `CC_Visualization3DWindow` (å®Œæ•´çš„ 3D å¯è§†åŒ–çª—å£)
  - å·¦ä¾§ï¼šé¢éƒ¨é®ç½©å¯è§†åŒ–
  - å³ä¾§ï¼š3D HSL åœ†æŸ±æ¥”å½¢ç‚¹äº‘
  - äº¤äº’åŠŸèƒ½ï¼šé¼ æ ‡æ‹–åŠ¨æ—‹è½¬ã€æ»šè½®ç¼©æ”¾
  - é¢„è®¾è§†è§’ï¼šæ­£é¢ã€ä¾§é¢ã€ä¿¯è§†ã€æ–œè§†
  - ä¿å­˜æˆªå›¾åŠŸèƒ½

#### æ–°å¢ä½ç½®
- **æ–‡ä»¶**: `CC_Main.py`
- **è¡Œæ•°**: 2204-2505ï¼ˆçº¦ 300 è¡Œï¼‰
- **ä½ç½®**: `CC_MainWindow` ç±»ä¹‹åï¼Œ`main()` å‡½æ•°ä¹‹å‰

#### æ›´æ–°çš„æ–¹æ³•
- `_show_visualization()` - ç§»é™¤ TODO å ä½ç¬¦ï¼Œä½¿ç”¨çœŸæ­£çš„ä»£ç 

---

### ä¿®å¤ 3: å»¶è¿ŸåŠ è½½ä¼˜åŒ–ï¼ˆæ€§èƒ½æå‡ 40 å€ï¼‰

**å·²åœ¨ä¹‹å‰å®Œæˆï¼Œç»§ç»­ä¿æŒ**:
- ç‚¹å‡»ç…§ç‰‡æ—¶ï¼šåªåŠ è½½ point_cloudï¼ˆ5msï¼‰
- ç‚¹å‡» Visualize æ—¶ï¼šå»¶è¿ŸåŠ è½½ image å’Œ maskï¼ˆ200msï¼‰

---

## ğŸ“Š CC_Visualization3DWindow ç±»åŠŸèƒ½

### ä¸»è¦ç‰¹æ€§

1. **åŒé¢æ¿å¸ƒå±€**
   - **å·¦ä¾§**: é¢éƒ¨é®ç½©è¦†ç›–åœ¨åŸå›¾ä¸Šï¼ˆåŠé€æ˜é’è‰²ï¼‰
   - **å³ä¾§**: 3D HSL åœ†æŸ±æ¥”å½¢ç‚¹äº‘

2. **äº¤äº’æ§åˆ¶**
   - **é¼ æ ‡å·¦é”®æ‹–åŠ¨**: æ—‹è½¬ 3D è§†å›¾
   - **é¼ æ ‡æ»šè½®**: ç¼©æ”¾
   - **é¢„è®¾è§†è§’æŒ‰é’®**: æ­£é¢ã€ä¾§é¢ã€ä¿¯è§†ã€æ–œè§†

3. **ä¿å­˜åŠŸèƒ½**
   - ä¿å­˜ 3D å¯è§†åŒ–æˆªå›¾
   - ä¿å­˜é¢éƒ¨é®ç½©å›¾åƒ
   - è‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³æ–‡ä»¶å

### æ ¸å¿ƒæ–¹æ³•

```python
class CC_Visualization3DWindow(QWidget):
    def __init__(self, rgb_image, mask, point_cloud, renderer, photo_name)
    
    def _create_ui(self)           # åˆ›å»º UI
    def _save_screenshot(self)     # ä¿å­˜æˆªå›¾
    def _update_render(self)       # æ›´æ–° 3D æ¸²æŸ“
    
    # é¼ æ ‡äº¤äº’
    def _on_mouse_press(self, event)
    def _on_mouse_move(self, event)
    def _on_mouse_release(self, event)
    def _on_wheel(self, event)
    
    # è§†è§’é¢„è®¾
    def _set_camera_preset(self, preset: str)
```

---

## ğŸ¯ å®Œæ•´çš„ Visualize æµç¨‹

### 1. ç‚¹å‡»ç…§ç‰‡ï¼ˆå»¶è¿ŸåŠ è½½ï¼‰
```python
_select_photo()
â”œâ”€â”€ åŠ è½½ point_cloud from database (5ms)
â”œâ”€â”€ self.current_photo_rgb = None  # å»¶è¿ŸåŠ è½½
â”œâ”€â”€ self.current_mask = None       # å»¶è¿ŸåŠ è½½
â””â”€â”€ visualize_btn.setEnabled(True)
```

### 2. ç‚¹å‡» Visualize æŒ‰é’®
```python
_show_visualization()
â”œâ”€â”€ æ£€æŸ¥: point_cloud is None? â†’ è­¦å‘Šå¹¶è¿”å›
â”œâ”€â”€ å»¶è¿ŸåŠ è½½ image å’Œ mask (200ms)
â”‚   â”œâ”€â”€ _load_image()
â”‚   â””â”€â”€ process_image(return_mask=True)
â”œâ”€â”€ åˆ›å»º CC_Visualization3DWindow
â”‚   â”œâ”€â”€ å·¦ä¾§: é¢éƒ¨é®ç½© + åŸå›¾ overlay
â”‚   â””â”€â”€ å³ä¾§: 3D ç‚¹äº‘å¯è§†åŒ–
â””â”€â”€ viz_window.show()
```

### 3. 3D å¯è§†åŒ–çª—å£
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¨ è‚¤è‰²3Dåœ†æŸ±æ¥”å½¢å¯è§†åŒ– (æ‹–åŠ¨é¼ æ ‡æ—‹è½¬ï¼Œæ»šè½®ç¼©æ”¾)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ£€æµ‹åˆ°çš„é¢éƒ¨é®ç½©  â”‚  3D HSL åœ†æŸ±æ¥”å½¢ (H: 15-25Â°)       â”‚
â”‚                  â”‚                                     â”‚
â”‚   [åŸå›¾+é®ç½©]    â”‚    [3D äº¤äº’å¼ç‚¹äº‘]                 â”‚
â”‚                  â”‚                                     â”‚
â”‚  é®ç½©è¦†ç›– 19.4%  â”‚  50,000 ä¸ªç‚¹å·²å¯è§†åŒ–               â”‚
â”‚  æ’é™¤: çœ¼ç›ã€    â”‚  ğŸ–±ï¸ å·¦é”®æ‹–åŠ¨: æ—‹è½¬ | æ»šè½®: ç¼©æ”¾  â”‚
â”‚  çœ‰æ¯›ã€å˜´å”‡ç­‰    â”‚  é¢œè‰²: HSL æ˜ å°„åˆ° RGB              â”‚
â”‚                  â”‚  â¬†ï¸ Yè½´: äº®åº¦ | ğŸ“ è§’åº¦: è‰²è°ƒ     â”‚
â”‚                  â”‚                                     â”‚
â”‚                  â”‚  å¿«é€Ÿè§†è§’:                          â”‚
â”‚                  â”‚  [æ­£é¢] [ä¾§é¢] [ä¿¯è§†] [æ–œè§†]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   [ğŸ’¾ ä¿å­˜æˆªå›¾]  [å…³é—­]
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### é¢éƒ¨é®ç½©å¯è§†åŒ–

```python
# åˆ›å»ºåŠé€æ˜é’è‰²é®ç½©è¦†ç›–
overlay = rgb_image.copy()
mask_colored = np.zeros_like(overlay)
mask_colored[mask == 1] = [78, 205, 196]  # Teal
alpha = 0.4
overlay = cv2.addWeighted(overlay, 1, mask_colored, alpha, 0)
```

### 3D ç‚¹äº‘æ¸²æŸ“

```python
# ä¸Šä¼ ç‚¹äº‘åˆ° Taichi æ¸²æŸ“å™¨
renderer.set_point_cloud(point_cloud, color_mode='hsl')

# äº¤äº’å¼æ¸²æŸ“
renderer.render()
render_img = renderer.get_image()
# è½¬æ¢ä¸º QPixmap æ˜¾ç¤º
```

### è§†è§’é¢„è®¾

```python
presets = {
    "front": (20, 10),   # æ­£é¢ (h_angle, v_angle)
    "side": (90, 10),    # ä¾§é¢
    "top": (45, 70),     # ä¿¯è§†
    "angle": (45, 20)    # æ–œè§†
}
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

### ä¿®æ”¹çš„æ–‡ä»¶
1. **CC_Main.py**
   - ä¿®å¤ `_show_visualization()` çš„å¸ƒå°”åˆ¤æ–­
   - æ·»åŠ  `CC_Visualization3DWindow` ç±»ï¼ˆ300 è¡Œï¼‰
   - æ›´æ–° `_show_visualization()` å®ç°

### å‚è€ƒæ–‡ä»¶
- **CC_MainApp_restored.py** - åŸå§‹ä»£ç æ¥æº

---

## âœ… éªŒè¯æ¸…å•

- [x] **é”™è¯¯ä¿®å¤**: `ValueError` å·²è§£å†³ï¼ˆä½¿ç”¨ `is None`ï¼‰
- [x] **ç±»æ•´åˆ**: `CC_Visualization3DWindow` å·²æ·»åŠ åˆ° `CC_Main.py`
- [x] **æ–¹æ³•æ›´æ–°**: `_show_visualization()` ä½¿ç”¨çœŸæ­£çš„ä»£ç 
- [x] **å»¶è¿ŸåŠ è½½**: ä¿æŒå·²æœ‰çš„æ€§èƒ½ä¼˜åŒ–
- [x] **ä»£ç éªŒè¯**: æ— è¯­æ³•é”™è¯¯ï¼Œåªæœ‰è­¦å‘Š

---

## ğŸ‰ æµ‹è¯•æ­¥éª¤

1. **è¿è¡Œåº”ç”¨**
   ```bash
   python CC_Main.py
   ```

2. **é€‰æ‹©ç…§ç‰‡**
   - ç‚¹å‡»ä»»æ„ç…§ç‰‡
   - åº”è¯¥ç«‹å³æ˜¾ç¤º Statisticsï¼ˆ5msï¼‰
   - ä¸ä¼šçœ‹åˆ° "Face mask created" æ—¥å¿—

3. **ç‚¹å‡» Visualize æŒ‰é’®**
   - ç¬¬ä¸€æ¬¡ç‚¹å‡»ä¼šçœ‹åˆ° "Lazy loading..." æ—¥å¿—ï¼ˆ200msï¼‰
   - æ‰“å¼€ 3D å¯è§†åŒ–çª—å£
   - å·¦ä¾§ï¼šé¢éƒ¨é®ç½©è¦†ç›–åœ¨åŸå›¾ä¸Š
   - å³ä¾§ï¼š3D HSL ç‚¹äº‘

4. **äº¤äº’æµ‹è¯•**
   - æ‹–åŠ¨é¼ æ ‡ï¼šæ—‹è½¬ 3D è§†å›¾
   - æ»šè½®ï¼šç¼©æ”¾
   - ç‚¹å‡»é¢„è®¾æŒ‰é’®ï¼šåˆ‡æ¢è§†è§’
   - ä¿å­˜æˆªå›¾ï¼šç”Ÿæˆä¸¤å¼ å›¾ç‰‡ï¼ˆ3D + maskï¼‰

---

## ğŸš€ æ€§èƒ½å¯¹æ¯”

### ä¿®å¤å‰
```
ç‚¹å‡»ç…§ç‰‡:   200ms (æ¯æ¬¡éƒ½è¿è¡Œé¢éƒ¨æ£€æµ‹) âŒ
Visualize:  ModuleNotFoundError âŒ
```

### ä¿®å¤å
```
ç‚¹å‡»ç…§ç‰‡:   5ms (åªåŠ è½½ point_cloud) âœ…
Visualize:  200ms (å»¶è¿ŸåŠ è½½ï¼Œç¬¬ä¸€æ¬¡) âœ…
           0ms (å·²åŠ è½½ç¼“å­˜) âœ…
3D çª—å£:    å®Œæ•´åŠŸèƒ½ï¼Œæµç•…äº¤äº’ âœ…
```

---

## ğŸ“ ä»£ç ç»Ÿè®¡

**CC_Visualization3DWindow ç±»**:
- æ€»è¡Œæ•°: ~300 è¡Œ
- æ–¹æ³•æ•°: 10 ä¸ª
- åŠŸèƒ½: 3D å¯è§†åŒ– + äº¤äº’æ§åˆ¶ + æˆªå›¾ä¿å­˜

**ä¿®å¤çš„ Bug**:
1. ValueError (numpy æ•°ç»„å¸ƒå°”åˆ¤æ–­)
2. ModuleNotFoundError (ç¼ºå¤±çš„ç±»)

**æ€§èƒ½æå‡**:
- ç‚¹å‡»ç…§ç‰‡: 40x æ›´å¿« (200ms â†’ 5ms)
- Visualize: æŒ‰éœ€åŠ è½½ï¼ˆåˆç†ç­‰å¾…ï¼‰

---

## ğŸŠ æ€»ç»“

âœ… **æ‰€æœ‰é—®é¢˜éƒ½å·²è§£å†³**ï¼š
1. âœ… ValueError ä¿®å¤ - ä½¿ç”¨ `is None` æ£€æŸ¥ numpy æ•°ç»„
2. âœ… CC_Visualization3DWindow æ•´åˆ - å®Œæ•´çš„ 3D å¯è§†åŒ–çª—å£
3. âœ… å»¶è¿ŸåŠ è½½ä¿æŒ - æ€§èƒ½æå‡ 40 å€
4. âœ… ä»£ç éªŒè¯é€šè¿‡ - æ— é”™è¯¯

**ç°åœ¨å¯ä»¥å®Œæ•´ä½¿ç”¨ 3D å¯è§†åŒ–åŠŸèƒ½äº†ï¼** ğŸ‰
